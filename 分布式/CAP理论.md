# 分布式系统的挑战

对于分布式系统来说,很难做到完全无状态,相反,很多分布式的系统组成的组件都是有状态的.

那么,其难点就是在于如何保证各个节点的状态同步性.

而CAP定理,就是分布式状态同步的基本定理,也是理解分布式系统的起点

# 什么是CAP定理

在分布式的系统中,可以抽象出三个指标来对这个系统进行评价,分别是

-  Consistency (一致性)
-  Availability (可用性)
-  Partition tolerance (分区容错性)

取这三个指标的第一个字母,就构成了CAP定理,通常CAP定理只能在三者之中满足两个

##  Partition tolerance  分区容错性

对于大多数的分布式系统来说,各个机器分布在多个子网络中,每一子网络就被称为一个区,而分区容错性指的就是分区之间的通信有可能是失效的,在系统设计的时候必须要考虑到这种情况.

一般来说,CAP中P是必须要满足的,所以CAP定理中一般是满足CP或者AP

## Consistency 一致性

该特性表明,在系统中,写入了一个值后,读取操作必须能够返回这个值.

举例来说,假设有一个分布式的数据库,那么用户在向其写入了一个值`v0`之后,另外用户以同样条件来读取,应该也可以读到`v0`,称为一致性.

 对于数据分布在不同节点上的数据上来说，如果在某个节点更新了数据，那么在其他节点如果都能读取到这个最新的数据，那么就称为强一致，如果有某个节点没有读取到，那就是分布式不一致。 

## Availability 可用性

非故障的节点在合理的时间内返回合理的响应(不是错误和超时的响应)。可用性的两个关键一个是合理的时间，一个是合理的响应。合理的时间指的是请求不能无限被阻塞，应该在合理的时间给出返回。合理的响应指的是系统应该明确返回结果并且结果是正确的，这里的正确指的是比如应该返回50，而不是返回40。

# 权衡

在分布式系统中，分区容忍性必不可少，因为需要总是假设网络是不可靠的。因此，CAP 理论实际上是要在可用性和一致性之间做权衡。

可用性和一致性往往是冲突的，很难使它们同时满足。在多个节点之间进行数据同步时，

- 为了保证一致性（CP），不能访问未同步完成的节点，也就失去了部分可用性；
- 为了保证可用性（AP），允许读取所有节点的数据，但是数据可能不一致。

如果保证 G2 的一致性，那么 G1 必须在写操作时，锁定 G2 的读操作和写操作。只有数据同步后，才能重新开放读写。锁定期间，G2 不能读写，没有可用性不。

如果保证 G2 的可用性，那么势必不能锁定 G2，所以一致性不成立。

综上所述，G2 无法同时做到一致性和可用性。系统设计时只能选择一个目标。如果追求一致性，那么无法保证所有节点的可用性；如果追求所有节点的可用性，那就没法做到一致性。

