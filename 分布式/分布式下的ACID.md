在之前,我们已经说明了什么是ACID,主要内容是Mysq下的ACID.在单机下的ACID并不复杂,可以通过锁,时间序列等等的机制保证操作之间的不可见性与有序性,让系统实现ACID特性.

但是,在分布式下的ACID,不仅要面对着以上的情况,还要面对高延迟,错误发生的情况,这会使实现难度更上一层楼.

具体来说,为了实现ACID特性,我们首先要知道分布式的事务协议,如二阶段提交协议和TCC(Try-Confirm-Cancel)

## 二阶段提交协议

二阶段提交协议，顾名思义，就是通过二阶段的协商来完成一个提交操作，那么具体是怎么操作的呢

首先,假设我们具有一个分布式系统,里面有节点A,B,C,D四个.在这四个节点中,A发送了消息给B,B收到了消息后,由B作为协调者(Coordinator),向C,D发送消息.B作为协调者发送给CD消息后,进入二阶段提交的第一个阶段:提交请求阶段,也称为投票阶段.

为了方便,我们假设CD都会正确响应B的信息并在投票阶段会与B的预期一致.

在投票阶段中,B发送的消息到了CD中,CD,包括B会进行评估,如果评估通过,则向协调者,也就是B发送投票信息,并会将这段评估对应的事务进行锁定(这个我们留在后面说).根据前面所说的,我们假设BCD都会投同意,所以总体的结果就是同意,在B中汇总投票并得到结果后,就会进入提交执行阶段(又称完成阶段).

进入了这个阶段后,B再次向B,C,D发送执行事务的消息,在执行完成后,将执行结果返回给B.B将汇总的结果返回给A.

这就是一个二阶段提交的完整流程了.再回来说一下我们刚刚所说的锁定是什么意思,在评估阶段,每个节点收到了要求执行事务的信息时,如果投票要求执行事务,也就是同意的话,就不可以在执行阶段放弃执行,**在一个参与者投同意票之前,必须保证自身能够执行这个事务**,这个特性是二阶段提交能够运行的保证.

![](http://imageblog.boyn.top/202003011216_517.png)



但是二阶段提交也有其自身的缺点,我们看到,在投票阶段,如果节点能够执行事务的话,就会将资源锁住,但是如果在从锁住到执行,甚至从锁住到放弃执行这个过程比较漫长,那么就会造成资源浪费,使得并发性能降低了.

为了解决这种问题,我们引出前面说到的TCC操作

## TCC操作

TCC是Try,Confirm,Cancel的3个操作简称,分别是预留,确认和撤销的意思.这三个操作分为了两个阶段,*预留*与*确认或撤销*

首先,我们假定还是有4个节点,ABCD,

在第一个阶段,预留中,A向BCD发送消息,要求其预留执行事务所需要的资源.

对于BCD节点来说,预留阶段的处理大部分是将需要更改的资源锁住,并将成功的信息返回给A

A确认所有节点都成功预留后,进入第二个阶段,即确认,如果中间有任意节点发生错误,那么就进入撤销,将预留资源放开.

在确认阶段中,A向BCD发送消息,令各个节点执行事务,在执行完成后,发回给A确认完成的操作.

在我们看来,TCC是一个比二阶段提交更为轻量级的操作,其中要注意的是,确认和撤销必须是幂等的,因为这两个操作可能会失败并重试.

